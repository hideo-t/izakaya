<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#e53935">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>å±…é…’å±‹ãƒ‰ãƒªãƒ•ã‚¿ãƒ¼ ã€œãƒ€ãƒ¡ç¤¾é•·ã®çµŒå–¶é©å‘½ã€œ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Zen+Maru+Gothic:wght@400;700&display=swap');

:root {
  --primary:#e53935;--primary-dark:#b71c1c;
  --secondary:#ff9800;--secondary-dark:#f57c00;
  --accent:#ffab40;
  --dark:#2c1a14;--dark-mid:#3e2723;--dark-light:#5d4037;
  --light:#fff3e0;--gray:#efebe9;
  --success:#66bb6a;--warning:#ffc107;--danger:#ef5350;--info:#42a5f5;
  --header-h:52px;--footer-h:62px;--tab-h:48px;
  --sab:env(safe-area-inset-bottom,0px);
  --radius:14px;--radius-sm:8px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%;overflow:hidden}
body{
  font-family:'Noto Sans JP','Zen Maru Gothic',sans-serif;
  background:var(--dark);color:var(--light);
  height:100%;overflow:hidden;position:relative;
  line-height:1.55;font-size:14px;
}
button{font-family:inherit;cursor:pointer;border:none;outline:none}
input,select,textarea{font-family:inherit;outline:none}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:rgba(255,152,0,.3);border-radius:2px}

/* ===== SPLASH ===== */
#splash{
  position:fixed;inset:0;z-index:9999;
  background:radial-gradient(ellipse at 50% 30%,#4e342e,var(--dark));
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  transition:opacity .6s,transform .6s;
}
#splash.hide{opacity:0;pointer-events:none;transform:scale(1.05)}
#splash h1{
  font-family:'Zen Maru Gothic',cursive;font-size:2.2rem;
  color:var(--secondary);text-shadow:0 0 30px rgba(255,152,0,.4);
  margin-bottom:4px;
}
#splash .sub{color:rgba(255,243,224,.6);font-size:.9rem;margin-bottom:24px;letter-spacing:2px}
.load-bar{width:200px;height:3px;background:rgba(255,255,255,.12);border-radius:2px;overflow:hidden}
.load-fill{height:100%;width:0;background:linear-gradient(90deg,var(--secondary),var(--accent));transition:width .3s}
#splash .tip{color:rgba(255,255,255,.35);font-size:.72rem;margin-top:18px;max-width:260px;text-align:center}

/* ===== APP WRAPPER ===== */
#app{display:none;height:100%;flex-direction:column}
#app.show{display:flex}

/* ===== HEADER ===== */
header{
  height:var(--header-h);min-height:var(--header-h);
  background:rgba(0,0,0,.92);backdrop-filter:blur(12px);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:2px solid var(--secondary);z-index:100;
  position:relative;
}
header::after{
  content:'';position:absolute;bottom:-2px;left:0;width:100%;height:1px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
}
.h-left{display:flex;align-items:center;gap:8px}
.shop-name{font-weight:700;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px}
.h-center{text-align:center}
.date-d{font-size:.75rem;color:var(--accent);font-weight:700;letter-spacing:1px}
.cash-box{
  background:rgba(255,152,0,.12);padding:4px 10px;border-radius:20px;
  border:1px solid rgba(255,152,0,.35);font-weight:700;font-size:.82rem;
  display:flex;align-items:center;gap:4px;
}
.cash-val{color:var(--accent)}

/* ===== TABS ===== */
.tabs{
  display:flex;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(255,152,0,.15);z-index:90;min-height:var(--tab-h);
}
.tab-b{
  flex:1;background:none;color:rgba(255,255,255,.45);
  font-size:1.15rem;padding:6px 0 4px;position:relative;
  transition:color .2s;display:flex;flex-direction:column;align-items:center;gap:1px;
}
.tab-b .tl{font-size:.6rem;letter-spacing:.5px}
.tab-b.active{color:var(--secondary)}
.tab-b.active::after{
  content:'';position:absolute;bottom:0;left:20%;width:60%;height:2px;
  background:var(--secondary);border-radius:1px;
}

/* ===== MAIN SCROLL ===== */
.main-scroll{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px 12px 16px;-webkit-overflow-scrolling:touch}
.pane{display:none}
.pane.active{display:block;animation:fadeUp .25s}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* ===== CARDS ===== */
.card{
  background:linear-gradient(135deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
  border:1px solid rgba(255,152,0,.1);border-radius:var(--radius);
  padding:14px;margin-bottom:10px;position:relative;overflow:hidden;
}
.card::before{
  content:'';position:absolute;top:0;left:0;width:4px;height:100%;
  background:var(--secondary);border-radius:2px 0 0 2px;
}
.card-title{font-size:.7rem;color:rgba(255,255,255,.5);margin-bottom:2px;letter-spacing:1px}
.card-val{font-size:1.5rem;font-weight:900;color:var(--accent)}
.card-trend{font-size:.72rem;margin-top:2px}
.trend-up{color:var(--success)}
.trend-down{color:var(--danger)}

/* METRICS ROW */
.metrics{display:flex;gap:8px;overflow-x:auto;padding:2px 0 8px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
.metrics .card{flex:0 0 calc(33.3% - 6px);min-width:115px;scroll-snap-align:start;padding:10px 12px}
.metrics .card-val{font-size:1.2rem}

/* PRESIDENT MSG */
.pres-msg{
  background:linear-gradient(135deg,rgba(93,64,55,.6),rgba(62,39,35,.8));
  border:1px solid rgba(255,152,0,.25);border-radius:var(--radius);
  padding:12px 14px;margin:10px 0;font-style:italic;font-size:.88rem;
  display:flex;align-items:flex-start;gap:10px;
}
.pres-face{font-size:1.6rem;flex-shrink:0}

/* ACTION BTNS */
.actions{display:flex;gap:8px;margin:12px 0}
.btn-p,.btn-s,.btn-o{
  flex:1;padding:13px 8px;border-radius:var(--radius);font-weight:700;font-size:.88rem;
  transition:transform .1s,box-shadow .2s;text-align:center;
}
.btn-p:active,.btn-s:active,.btn-o:active{transform:scale(.97)}
.btn-p{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 16px rgba(229,57,53,.3)}
.btn-s{background:rgba(255,255,255,.08);color:#fff;border:1px solid var(--secondary)}
.btn-o{background:rgba(255,255,255,.05);color:var(--accent);border:1px solid rgba(255,152,0,.2)}
.btn-sm{padding:8px 14px;border-radius:20px;font-size:.75rem;font-weight:700}
.btn-p.btn-sm{font-size:.75rem}

/* CHART */
.chart-wrap{background:rgba(0,0,0,.2);border-radius:var(--radius);padding:12px;margin:10px 0}
.chart-wrap canvas{width:100%!important;height:auto!important}

/* LOG */
.log-box{
  background:rgba(0,0,0,.35);border-radius:var(--radius);margin-top:14px;overflow:hidden;
}
.log-hdr{
  padding:8px 12px;background:rgba(0,0,0,.25);display:flex;justify-content:space-between;
  align-items:center;font-size:.78rem;color:rgba(255,255,255,.6);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.log-body{padding:6px 12px;max-height:180px;overflow-y:auto}
.log-e{
  padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);
  font-size:.78rem;display:flex;gap:8px;align-items:flex-start;
}
.log-t{color:var(--accent);font-size:.68rem;min-width:48px;flex-shrink:0}

/* ===== MENU PANE ===== */
.sec-title{font-size:.82rem;font-weight:700;color:var(--accent);margin:14px 0 8px;display:flex;align-items:center;gap:6px}
.menu-item{
  background:rgba(255,255,255,.06);border-radius:var(--radius-sm);
  padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;
}
.mi-left{flex:1}
.mi-name{font-weight:700;font-size:.88rem;display:flex;align-items:center;gap:4px}
.mi-meta{font-size:.7rem;color:rgba(255,255,255,.5);margin-top:2px}
.cost-badge{
  display:inline-block;padding:1px 7px;border-radius:10px;font-size:.65rem;font-weight:700;
}
.cb-ok{background:rgba(102,187,106,.15);color:#a5d6a7}
.cb-warn{background:rgba(255,193,7,.15);color:#ffe082}
.cb-bad{background:rgba(239,83,80,.15);color:#ef9a9a}
.mi-price{font-weight:700;font-size:1rem;color:var(--accent)}

/* STAFF */
.staff-card{
  background:rgba(255,255,255,.06);border-radius:var(--radius);
  padding:12px;margin-bottom:8px;display:flex;gap:12px;align-items:center;
}
.s-avatar{
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,var(--secondary),var(--accent));
  display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;
}
.s-info{flex:1}
.s-name{font-weight:700;font-size:.92rem}
.s-role{font-size:.7rem;color:rgba(255,255,255,.5)}
.gauge{width:100%;height:5px;background:rgba(255,255,255,.12);border-radius:3px;margin-top:6px;overflow:hidden}
.gauge-fill{height:100%;border-radius:3px;transition:width .4s}
.g-morale{background:linear-gradient(90deg,var(--success),#aed581)}
.g-fatigue{background:linear-gradient(90deg,var(--warning),var(--danger))}
.s-stats{display:flex;gap:12px;margin-top:4px;font-size:.68rem;color:rgba(255,255,255,.5)}

/* MARKETING */
.sns-post{
  background:rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;margin-bottom:10px;
}
.sns-post textarea{
  width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,152,0,.2);
  border-radius:var(--radius-sm);padding:10px;color:var(--light);font-size:.82rem;
  resize:none;height:70px;
}
.ad-opt{
  background:rgba(255,255,255,.05);border-radius:var(--radius-sm);
  padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;
  cursor:pointer;border:1px solid transparent;transition:border .2s;
}
.ad-opt.sel{border-color:var(--secondary);background:rgba(255,152,0,.08)}
.ad-opt .price{margin-left:auto;color:var(--accent);font-weight:700;font-size:.82rem}

/* ANALYSIS */
.metric-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:.85rem;
}
.mr-label{color:rgba(255,255,255,.6)}
.mr-val{font-weight:700;color:var(--accent)}
.badge{padding:2px 8px;border-radius:10px;font-size:.65rem;font-weight:700;margin-left:6px}
.badge-ok{background:rgba(102,187,106,.15);color:#a5d6a7}
.badge-warn{background:rgba(255,193,7,.15);color:#ffe082}
.badge-bad{background:rgba(239,83,80,.15);color:#ef9a9a}
.advice-box{
  background:linear-gradient(135deg,rgba(66,165,245,.1),rgba(66,165,245,.05));
  border:1px solid rgba(66,165,245,.2);border-radius:var(--radius);
  padding:12px;margin-top:12px;font-size:.82rem;line-height:1.7;
}
.advice-box::before{content:'ğŸ’¡ ';font-size:1rem}

/* ===== FOOTER ===== */
footer{
  height:calc(var(--footer-h) + var(--sab));min-height:var(--footer-h);
  background:rgba(0,0,0,.94);backdrop-filter:blur(12px);
  border-top:1px solid rgba(255,152,0,.2);z-index:100;
  padding-bottom:var(--sab);
}
.f-row{display:flex;height:var(--footer-h);align-items:center;justify-content:space-around}
.f-btn{
  background:none;color:rgba(255,255,255,.55);display:flex;flex-direction:column;
  align-items:center;gap:2px;padding:4px 8px;font-size:.62rem;transition:color .2s;
}
.f-btn .fi{font-size:1.25rem}
.f-btn:active{color:var(--secondary)}

/* ===== MODAL ===== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:1000;
  display:flex;align-items:center;justify-content:center;padding:20px;
  animation:fadeIn .2s;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{
  background:linear-gradient(135deg,#4e342e,var(--dark-mid));
  border:2px solid var(--secondary);border-radius:18px;
  padding:24px 20px;max-width:360px;width:100%;max-height:80vh;overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.6);animation:modalPop .25s;
}
@keyframes modalPop{from{transform:scale(.92);opacity:0}to{transform:none;opacity:1}}
.modal-box h2{font-size:1.1rem;margin-bottom:10px;color:var(--accent)}
.modal-box p{font-size:.85rem;color:rgba(255,255,255,.8);margin-bottom:14px;line-height:1.7}
.choice-btn{
  display:block;width:100%;padding:12px;margin-bottom:8px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,152,0,.2);
  border-radius:var(--radius-sm);color:var(--light);font-size:.85rem;
  text-align:left;transition:all .2s;cursor:pointer;
}
.choice-btn:hover,.choice-btn:active{background:rgba(255,152,0,.15);border-color:var(--secondary)}

/* TOAST */
.toast{
  position:fixed;bottom:calc(var(--footer-h) + var(--sab) + 12px);
  left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.92);color:#fff;padding:10px 20px;
  border-radius:24px;border-left:3px solid var(--secondary);
  font-size:.8rem;z-index:2000;white-space:nowrap;
  box-shadow:0 4px 16px rgba(0,0,0,.4);animation:toastIn .3s;
  pointer-events:none;
}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,12px)}to{opacity:1;transform:translate(-50%,0)}}

/* AUTO INDICATOR */
.auto-badge{
  position:fixed;top:calc(var(--header-h) + 4px);right:8px;
  background:rgba(102,187,106,.9);color:#1b5e20;
  padding:3px 10px;border-radius:12px;font-size:.68rem;font-weight:700;
  z-index:95;animation:pulse 2s infinite;display:none;
}
.auto-badge.on{display:block}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* SPEED SELECT */
.speed-row{display:flex;gap:6px;margin-top:8px}
.speed-btn{
  flex:1;padding:6px;border-radius:var(--radius-sm);font-size:.72rem;font-weight:700;
  background:rgba(255,255,255,.06);color:rgba(255,255,255,.5);border:1px solid transparent;
}
.speed-btn.active{border-color:var(--secondary);color:var(--secondary);background:rgba(255,152,0,.1)}

/* STRATEGY SELECT */
.strat-row{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
.strat-btn{
  padding:6px 10px;border-radius:var(--radius-sm);font-size:.72rem;font-weight:700;
  background:rgba(255,255,255,.06);color:rgba(255,255,255,.5);border:1px solid transparent;
}
.strat-btn.active{border-color:var(--secondary);color:var(--secondary);background:rgba(255,152,0,.1)}

/* RESPONSIVE */
@media(max-width:340px){
  .metrics .card{flex:0 0 calc(50% - 4px);min-width:100px}
  .shop-name{max-width:70px;font-size:.75rem}
}
@media(min-width:500px){
  .main-scroll{max-width:480px;margin:0 auto}
}

/* ENDING */
.ending-overlay{
  position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.95);
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  padding:30px;text-align:center;animation:fadeIn .5s;
}
.ending-overlay h1{font-size:1.6rem;color:var(--accent);margin-bottom:8px}
.ending-overlay .rank{font-size:3rem;margin:10px 0}
.ending-overlay p{font-size:.9rem;color:rgba(255,255,255,.7);line-height:1.8;max-width:320px}
.ending-overlay button{margin-top:20px}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <h1>ğŸ¶ å±…é…’å±‹ãƒ‰ãƒªãƒ•ã‚¿ãƒ¼</h1>
  <div class="sub">ã€œãƒ€ãƒ¡ç¤¾é•·ã®çµŒå–¶é©å‘½ã€œ</div>
  <div class="load-bar"><div class="load-fill" id="loadFill"></div></div>
  <div class="tip">ç¬‘ã£ã¦ã€æ‚©ã‚“ã§ã€æ°—ã¥ãã€‚<br>æœ¬æ ¼æ´¾å±…é…’å±‹çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
</div>

<!-- AUTO BADGE -->
<div class="auto-badge" id="autoBadge">ğŸ¤– è‡ªå‹•é‹è»¢ä¸­</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="h-left">
      <div class="shop-name" id="shopName">å±…é…’å±‹ å‘æ—¥è‘µ</div>
    </div>
    <div class="h-center">
      <div class="date-d" id="dateDisp">1å¹´ç›® 4æœˆ 1é€±</div>
    </div>
    <div class="cash-box">
      <span>ğŸ’°</span>
      <span class="cash-val" id="cashDisp">500,000</span>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab-b active" data-tab="dash"><span>ğŸ“Š</span><span class="tl">çµŒå–¶</span></button>
    <button class="tab-b" data-tab="menu"><span>ğŸ½ï¸</span><span class="tl">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></button>
    <button class="tab-b" data-tab="staff"><span>ğŸ‘¥</span><span class="tl">äººæ</span></button>
    <button class="tab-b" data-tab="mkt"><span>ğŸ“±</span><span class="tl">é›†å®¢</span></button>
    <button class="tab-b" data-tab="analysis"><span>ğŸ“ˆ</span><span class="tl">åˆ†æ</span></button>
  </nav>

  <div class="main-scroll">
    <!-- DASHBOARD -->
    <div class="pane active" id="pane-dash">
      <div class="metrics" id="metricsRow"></div>
      <div class="pres-msg"><span class="pres-face">ğŸ‘¨â€ğŸ’¼</span><span id="presMsg">ã€Œä»Šæ—¥ã‚‚é ‘å¼µã‚‹ãï¼â€¦å¤šåˆ†ã€</span></div>
      <div class="actions">
        <button class="btn-p" id="btnNext">â–¶ 1é€±é–“é€²ã‚ã‚‹</button>
        <button class="btn-s" id="btnAuto">ğŸ¤– è‡ªå‹•OFF</button>
      </div>
      <div class="strat-row" id="stratRow" style="display:none">
        <button class="strat-btn active" data-st="balanced">âš–ï¸ ãƒãƒ©ãƒ³ã‚¹</button>
        <button class="strat-btn" data-st="profit">ğŸ’° åˆ©ç›Šé‡è¦–</button>
        <button class="strat-btn" data-st="popularity">â­ äººæ°—é‡è¦–</button>
        <button class="strat-btn" data-st="growth">ğŸš€ æ‹¡å¤§é‡è¦–</button>
      </div>
      <div class="speed-row" id="speedRow" style="display:none">
        <button class="speed-btn" data-sp="slow">ğŸ¢ é…ã„</button>
        <button class="speed-btn active" data-sp="normal">ğŸ‡ æ™®é€š</button>
        <button class="speed-btn" data-sp="fast">âš¡ é«˜é€Ÿ</button>
      </div>
      <div class="chart-wrap"><canvas id="salesChart"></canvas></div>
      <div class="log-box">
        <div class="log-hdr"><span>ğŸ“‹ çµŒå–¶æ—¥èªŒ</span><button style="background:none;border:none;color:rgba(255,255,255,.4);font-size:.75rem;cursor:pointer" id="logClear">ã‚¯ãƒªã‚¢</button></div>
        <div class="log-body" id="logBody"></div>
      </div>
    </div>

    <!-- MENU -->
    <div class="pane" id="pane-menu">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="sec-title">ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</div>
        <div style="font-size:.75rem;color:rgba(255,255,255,.5)">å¹³å‡åŸä¾¡ç‡ <span style="color:var(--accent);font-weight:700" id="avgCostR">32%</span></div>
      </div>
      <div id="menuList"></div>
      <div class="sec-title">ğŸŒŸ æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹ç™º</div>
      <div class="card" style="padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:.82rem">é–‹ç™ºè²»</span>
          <span style="color:var(--accent);font-weight:700">Â¥50,000</span>
        </div>
        <button class="btn-p btn-sm" id="btnDev" style="width:100%">ğŸ”¬ æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ç™ºã™ã‚‹</button>
      </div>
    </div>

    <!-- STAFF -->
    <div class="pane" id="pane-staff">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="sec-title">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</div>
        <div style="font-size:.75rem;color:rgba(255,255,255,.5)">å¹³å‡å£«æ°— <span style="color:var(--accent);font-weight:700" id="avgMorale">62%</span></div>
      </div>
      <div id="staffList"></div>
      <div class="sec-title">ğŸ“‹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn-o btn-sm" id="btnHire">ğŸ‘¤ æ¡ç”¨ Â¥30,000</button>
        <button class="btn-o btn-sm" id="btnParty">ğŸ‰ æ‡‡è¦ªä¼š Â¥20,000</button>
        <button class="btn-o btn-sm" id="btnTrain">ğŸ“š ç ”ä¿® Â¥15,000</button>
      </div>
    </div>

    <!-- MARKETING -->
    <div class="pane" id="pane-mkt">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="sec-title">ğŸ“± é›†å®¢æˆ¦ç•¥</div>
        <div style="font-size:.75rem;color:rgba(255,255,255,.5)">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ <span style="color:var(--accent);font-weight:700" id="followers">1,234</span></div>
      </div>
      <div class="sns-post">
        <textarea id="postText" placeholder="ä»Šæ—¥ã®ã‚ªã‚¹ã‚¹ãƒ¡ã¯...ğŸ»"></textarea>
        <button class="btn-p btn-sm" id="btnPost" style="margin-top:8px;width:100%">ğŸ“¤ SNSæŠ•ç¨¿ã™ã‚‹ (ç„¡æ–™)</button>
      </div>
      <div class="sec-title">ğŸ“¢ åºƒå‘Šå‡ºç¨¿</div>
      <div id="adOpts"></div>
    </div>

    <!-- ANALYSIS -->
    <div class="pane" id="pane-analysis">
      <div class="sec-title">ğŸ“ˆ çµŒå–¶åˆ†æ</div>
      <div id="analysisMetrics"></div>
      <div class="sec-title">ğŸ“Š å£²ä¸Šæ¨ç§»</div>
      <div class="chart-wrap"><canvas id="analysisChart"></canvas></div>
      <div id="adviceBox" class="advice-box">ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãšã¯åŸä¾¡ç‡ã®é«˜ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¦‹ç›´ã—ã‚’ã€‚</div>
    </div>
  </div>

  <footer>
    <div class="f-row">
      <button class="f-btn" id="fCalc"><span class="fi">ğŸ§®</span>é›»å“</button>
      <button class="f-btn" id="fSave"><span class="fi">ğŸ’¾</span>ä¿å­˜</button>
      <button class="f-btn" id="fLoad"><span class="fi">ğŸ“‚</span>èª­è¾¼</button>
      <button class="f-btn" id="fReset"><span class="fi">ğŸ”„</span>æœ€åˆã‹ã‚‰</button>
      <button class="f-btn" id="fInfo"><span class="fi">â“</span>éŠã³æ–¹</button>
    </div>
  </footer>
</div>

<!-- TOAST -->
<div id="toastC"></div>
<!-- MODAL -->
<div id="modalC"></div>

<script>
// ============================================================
// å±…é…’å±‹ãƒ‰ãƒªãƒ•ã‚¿ãƒ¼ - Full Game Engine
// ============================================================

// ---- GAME STATE ----
const G = {
  year:1, month:4, week:1, totalWeeks:0,
  cash:500000, loan:0,
  monthlySales:0, monthlyExpenses:0, monthlyProfit:0,
  profitRate:0, flRatio:65,
  popularity:30, repeatRate:20, customerAvg:2800,
  turnoverRate:1.2, seats:30, dailyCustomers:45,
  snsFollower:1234, snsEngagement:3.2, adLevel:'none',
  reputation:65, dataUsage:10,
  presidentLevel:1, presidentExp:0, awakened:false,
  presidentStage:0, // 0=dame,1=kizuki,2=kaishin,3=kakusei
  avgMorale:62, openTime:17, closeTime:0,
  salesHistory:[],
  autoMode:false, autoStrategy:'balanced', autoSpeed:'normal', autoTimer:null,
  eventsDone:[], logs:[],
  menu:[
    {id:1,name:'æè±†',emoji:'ğŸ«›',cost:80,price:300,popularity:70},
    {id:2,name:'åˆºèº«ç››ã‚Š',emoji:'ğŸŸ',cost:800,price:1800,popularity:85},
    {id:3,name:'å”æšã’',emoji:'ğŸ—',cost:120,price:450,popularity:75},
    {id:4,name:'ãƒãƒ†ãƒˆãƒ•ãƒ©ã‚¤',emoji:'ğŸŸ',cost:60,price:350,popularity:60},
    {id:5,name:'ç„¼ãé³¥',emoji:'ğŸ¢',cost:100,price:400,popularity:72},
    {id:6,name:'ç”Ÿãƒ“ãƒ¼ãƒ«',emoji:'ğŸº',cost:150,price:500,popularity:90},
    {id:7,name:'ãƒã‚¤ãƒœãƒ¼ãƒ«',emoji:'ğŸ¥ƒ',cost:80,price:450,popularity:80},
    {id:8,name:'å†·å¥´',emoji:'ğŸ§Š',cost:40,price:280,popularity:55},
  ],
  staff:[
    {id:1,name:'æºã•ã‚“',emoji:'ğŸ‘¨â€ğŸ³',role:'æ¿å‰',morale:60,skill:80,fatigue:20,salary:250000},
    {id:2,name:'ã¿ã‚†ã',emoji:'ğŸ‘©â€ğŸ³',role:'ãƒã‚¤ãƒˆãƒªãƒ¼ãƒ€ãƒ¼',morale:70,skill:65,fatigue:30,salary:130000},
    {id:3,name:'ã‚¿ã‚±ã‚·',emoji:'ğŸ§‘â€ğŸ³',role:'æ–°äºº',morale:90,skill:30,fatigue:10,salary:100000},
  ],
  nextStaffId:4, nextMenuId:9,
};

// ---- CALC ----
function costRate(c,p){return p>0?Math.round(c/p*100):0}
function avgCostRate(){
  if(!G.menu.length)return 0;
  return Math.round(G.menu.reduce((s,m)=>s+costRate(m.cost,m.price),0)/G.menu.length);
}
function totalLabor(){return G.staff.reduce((s,m)=>s+m.salary,0)}
function flRatio(){
  const food=G.monthlySales*avgCostRate()/100;
  const labor=totalLabor();
  return G.monthlySales>0?Math.round((food+labor)/G.monthlySales*100):0;
}
function breakEven(){
  const fixed=totalLabor()+200000; // rent+utilities
  const varRate=avgCostRate()/100;
  return varRate<1?Math.round(fixed/(1-varRate)):9999999;
}
function avgMorale(){
  if(!G.staff.length)return 0;
  return Math.round(G.staff.reduce((s,m)=>s+m.morale,0)/G.staff.length);
}

// ---- WEATHER & DAY ----
const WEATHERS=['â˜€ï¸ æ™´ã‚Œ','â˜ï¸ æ›‡ã‚Š','ğŸŒ§ï¸ é›¨','â„ï¸ é›ª'];
const W_MULT=[1.2,1.0,0.7,0.5];
function randomWeather(){
  const m=G.month;
  if(m>=6&&m<=7)return Math.random()<.4?2:Math.random()<.5?1:0;
  if(m==1||m==2)return Math.random()<.15?3:Math.random()<.3?1:0;
  return Math.random()<.2?2:Math.random()<.4?1:0;
}

// ---- CUSTOMER SIM ----
function simWeek(){
  const weather=randomWeather();
  const wMult=W_MULT[weather];
  const popMult=0.5+G.popularity/100;
  const staffMult=0.7+avgMorale()/300;
  const base=G.dailyCustomers*7;
  const customers=Math.floor(base*wMult*popMult*staffMult*(0.9+Math.random()*0.2));
  const avgSpend=G.customerAvg*(0.9+Math.random()*0.2);
  const weekSales=Math.floor(customers*avgSpend);

  G.monthlySales+=weekSales;
  const weekExpense=Math.floor(weekSales*avgCostRate()/100+totalLabor()/4+50000);
  G.monthlyExpenses+=weekExpense;
  const weekProfit=weekSales-weekExpense;
  G.cash+=weekProfit;

  // Update dynamics
  G.staff.forEach(s=>{
    s.fatigue=Math.min(100,s.fatigue+Math.floor(5+Math.random()*5));
    if(s.fatigue>70)s.morale=Math.max(0,s.morale-3);
  });
  G.avgMorale=avgMorale();

  // Popularity drift
  const qualFactor=G.staff.reduce((s,m)=>s+m.skill,0)/G.staff.length/100;
  if(Math.random()<.3)G.popularity=Math.max(0,Math.min(100,G.popularity+Math.floor((qualFactor-0.5)*5+(Math.random()-0.5)*4)));

  // SNS organic growth
  if(Math.random()<.2)G.snsFollower+=Math.floor(Math.random()*20*popMult);

  // Repeat rate
  G.repeatRate=Math.min(80,Math.max(5,Math.floor(G.popularity*0.6+G.avgMorale*0.2)));
  G.customerAvg=Math.floor(G.menu.reduce((s,m)=>s+m.price*m.popularity/100,0)/Math.max(1,G.menu.length)*1.8);

  return {customers,weekSales,weekProfit,weather:WEATHERS[weather]};
}

// ---- MONTH SETTLE ----
function settleMonth(){
  G.monthlyProfit=G.monthlySales-G.monthlyExpenses;
  G.profitRate=G.monthlySales>0?Math.round(G.monthlyProfit/G.monthlySales*100):0;
  G.flRatio=flRatio();
  G.salesHistory.push(G.monthlySales);
  if(G.salesHistory.length>12)G.salesHistory.shift();
  G.monthlySales=0;G.monthlyExpenses=0;
  // Loan interest
  if(G.loan>0){const interest=Math.floor(G.loan*0.02);G.cash-=interest;G.loan=Math.max(0,G.loan-Math.floor(G.loan*0.05))}
  // President exp
  G.presidentExp+=10;
  if(G.presidentExp>=G.presidentLevel*50){G.presidentLevel++;G.presidentExp=0;}
}

// ---- ADVANCE WEEK ----
function advanceWeek(){
  G.totalWeeks++;G.week++;
  let monthEnd=false;
  if(G.week>4){G.week=1;G.month++;monthEnd=true;if(G.month>12){G.month=1;G.year++;}}
  const res=simWeek();
  if(monthEnd)settleMonth();
  addLog(`${res.weather} å®¢${res.customers}äºº å£²ä¸ŠÂ¥${fmt(res.weekSales)} ${res.weekProfit>=0?'ğŸ“ˆ':'ğŸ“‰'}${res.weekProfit>=0?'+':''}Â¥${fmt(res.weekProfit)}`);
  checkEvents();
  checkEndings();
  updateAll();
  return res;
}

// ---- EVENTS ----
const EVENTS=[
  {id:'e1',title:'éŠ€è¡Œã‹ã‚‰ã®é›»è©±',cond:()=>G.totalWeeks>=2&&G.cash<400000,desc:'ã€Œå±±ç”°ç¤¾é•·ã€å…ˆæœˆã®è¿”æ¸ˆãŒâ€¦ã€éŠ€è¡Œå“¡ãƒ»ä¸­æ‘ã‹ã‚‰ã®é›»è©±ã€‚',
    choices:[
      {text:'ã€Œä½•ã¨ã‹ã—ã¾ã™ï¼ã€ï¼ˆæ°—åˆã§ä¹—ã‚Šåˆ‡ã‚‹ï¼‰',fn:()=>{G.cash-=30000;addLog('ğŸ’¸ å€Ÿé‡‘ã®ç©´ã‚’åˆ¥ã®å€Ÿé‡‘ã§â€¦');toast('è³‡é‡‘ãŒæ¸›ã£ãŸâ€¦')}},
      {text:'ã€ŒåŸä¾¡ç‡ã‚’è¦‹ç›´ã—ã¾ã™ã€ï¼ˆé›»å“ã‚’æ‰‹ã«å–ã‚‹ï¼‰',fn:()=>{G.dataUsage+=20;G.presidentStage=Math.max(G.presidentStage,1);addLog('ğŸ“Š åˆã‚ã¦åŸä¾¡è¨ˆç®—è¡¨ã‚’ä½œæˆã—ãŸï¼');toast('ğŸ’¡ æ°—ã¥ãã‚’å¾—ãŸï¼')}}
    ]},
  {id:'e2',title:'åŸä¾¡ç‡60%ã®åˆºèº«ç››ã‚Š',cond:()=>G.totalWeeks>=4&&G.menu.find(m=>m.name==='åˆºèº«ç››ã‚Š'&&costRate(m.cost,m.price)>40),
    desc:'çœ‹æ¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆºèº«ç››ã‚Šâ€¦åŸä¾¡ç‡ãŒé«˜ã™ããªã„ã‹ï¼Ÿ',
    choices:[
      {text:'ã€Œé«˜ç´šè·¯ç·šã§å‹è² ã ï¼ã€ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰',fn:()=>{G.popularity+=3;addLog('ğŸŸ åˆºèº«ç››ã‚Šã‚’æ®ãˆç½®ã')}},
      {text:'ã€Œé©æ­£ä¾¡æ ¼ã«è¦‹ç›´ãã†ã€',fn:()=>{const m=G.menu.find(x=>x.name==='åˆºèº«ç››ã‚Š');if(m)m.price=2200;G.dataUsage+=10;addLog('ğŸ’° åˆºèº«ç››ã‚Šã®ä¾¡æ ¼ã‚’é©æ­£åŒ–');toast('åŸä¾¡ç‡æ”¹å–„ï¼')}}
    ]},
  {id:'e3',title:'ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã®ä¸æº€',cond:()=>G.avgMorale<45,desc:'ã¿ã‚†ããŒã€Œæœ€è¿‘ã¿ã‚“ãªç–²ã‚Œã¦ã¾ã™â€¦ã€ã¨ã“ã¼ã—ãŸã€‚',
    choices:[
      {text:'ã€Œä»•æ–¹ãªã„ã€é ‘å¼µã‚Œã€',fn:()=>{G.staff.forEach(s=>s.morale=Math.max(0,s.morale-10));addLog('ğŸ˜” å£«æ°—ãŒã•ã‚‰ã«ä½ä¸‹â€¦')}},
      {text:'ã€Œã¿ã‚“ãªã§è©±ã—åˆãŠã†ã€',fn:()=>{G.cash-=10000;G.staff.forEach(s=>{s.morale=Math.min(100,s.morale+15);s.fatigue=Math.max(0,s.fatigue-10)});addLog('ğŸ’¬ å…¨ä½“ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§æ”¹å–„');toast('å£«æ°—å›å¾©ï¼')}}
    ]},
  {id:'e4',title:'å¸¸é€£ã®ç”°ä¸­ã•ã‚“',cond:()=>G.totalWeeks>=6&&G.repeatRate>30,desc:'ã€Œãƒã‚¹ã‚¿ãƒ¼ã€æœ€è¿‘ç¾å‘³ããªã£ãŸãªï¼ã€å¸¸é€£ã®ç”°ä¸­ã•ã‚“ãŒç¬‘ã£ãŸã€‚',
    choices:[
      {text:'ã€Œç”°ä¸­ã•ã‚“ã€ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ï¼ã€',fn:()=>{G.popularity+=5;G.repeatRate+=3;addLog('ğŸ» å¸¸é€£å®¢ã®è©•ä¾¡ãŒä¸ŠãŒã£ãŸï¼');toast('ãƒªãƒ”ãƒ¼ãƒˆç‡UPï¼')}}
    ]},
  {id:'e5',title:'é£Ÿæã®å€¤ä¸Šã’',cond:()=>G.totalWeeks>=8&&!G.eventsDone.includes('e5'),desc:'ä»•å…¥ã‚Œå…ˆã‹ã‚‰é€£çµ¡ã€‚ä¸»è¦é£ŸæãŒ15%å€¤ä¸ŠãŒã‚Šã™ã‚‹ã€‚',
    choices:[
      {text:'ã€Œä»•æ–¹ãªã„â€¦ãã®ã¾ã¾ä»•å…¥ã‚Œã‚‹ã€',fn:()=>{G.menu.forEach(m=>m.cost=Math.floor(m.cost*1.15));addLog('ğŸ“ˆ é£Ÿæã‚³ã‚¹ãƒˆãŒä¸Šæ˜‡â€¦')}},
      {text:'ã€Œåˆ¥ã®ä»•å…¥ã‚Œå…ˆã‚’æ¢ã™ã€',fn:()=>{G.cash-=20000;G.menu.forEach(m=>m.cost=Math.floor(m.cost*1.05));G.dataUsage+=5;addLog('ğŸ” æ–°ã—ã„ä»•å…¥ã‚Œå…ˆã‚’é–‹æ‹“');toast('ã‚³ã‚¹ãƒˆä¸Šæ˜‡ã‚’æŠ‘ãˆãŸï¼')}}
    ]},
  {id:'e6',title:'ç¤¾é•·ã€æ”¹å¿ƒã™',cond:()=>G.presidentStage>=1&&G.dataUsage>40&&G.profitRate>5,
    desc:'ã€Œå„²ã‹ã‚‹ã£ã¦ã€ã‚«ãƒƒã‚³æ‚ªããªã„ã‚“ã â€¦ã€åˆã‚ã¦é»’å­—ã‚’è¦‹ãŸç¤¾é•·ã®ç›®ã«å…‰ãŒå®¿ã£ãŸã€‚',
    choices:[
      {text:'ã€ŒçµŒå–¶ã‚’å­¦ã¼ã†ã€',fn:()=>{G.presidentStage=2;G.awakened=true;G.cash+=50000;addLog('ğŸŒŸ ç¤¾é•·ãŒæ”¹å¿ƒã—ãŸï¼çµŒå–¶å“²å­¦ãŒå¤‰ã‚ã‚‹');toast('ğŸ‰ ç¤¾é•·è¦šé†’ï¼')}}
    ]},
  {id:'e7',title:'ãƒ©ã‚¤ãƒãƒ«åº—å‡ºç¾',cond:()=>G.totalWeeks>=12,desc:'é§…å‰ã«æ–°ã—ã„å±…é…’å±‹ãŒã‚ªãƒ¼ãƒ—ãƒ³ã€‚å®¢è¶³ã«å½±éŸ¿ãŒå‡ºãã†ã ã€‚',
    choices:[
      {text:'ã€Œã†ã¡ã¯ã†ã¡ã ã€ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰',fn:()=>{G.popularity=Math.max(0,G.popularity-8);addLog('ğŸ˜° ãƒ©ã‚¤ãƒãƒ«åº—ã«å®¢ãŒæµã‚ŒãŸâ€¦')}},
      {text:'ã€Œçœ‹æ¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¼·åŒ–ã™ã‚‹ï¼ã€',fn:()=>{G.cash-=30000;G.popularity+=5;G.menu.forEach(m=>{if(m.popularity>70)m.popularity=Math.min(100,m.popularity+5)});addLog('ğŸ’ª ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¼·åŒ–ã§å¯¾æŠ—ï¼');toast('çœ‹æ¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¼·åŒ–ï¼')}}
    ]},
  {id:'e8',title:'TVå–æã®ãƒãƒ£ãƒ³ã‚¹',cond:()=>G.popularity>=60&&G.totalWeeks>=16,desc:'åœ°å…ƒãƒ†ãƒ¬ãƒ“å±€ã‹ã‚‰å–æä¾é ¼ãŒï¼ã“ã‚Œã¯ãƒãƒ£ãƒ³ã‚¹ã ã€‚',
    choices:[
      {text:'ã€Œãœã²ãŠé¡˜ã„ã—ã¾ã™ï¼ã€',fn:()=>{G.snsFollower+=500;G.popularity=Math.min(100,G.popularity+15);G.dailyCustomers=Math.floor(G.dailyCustomers*1.3);addLog('ğŸ“º TVå–æã§çŸ¥ååº¦çˆ†ä¸ŠãŒã‚Šï¼');toast('ğŸ‰ ãƒ†ãƒ¬ãƒ“åŠ¹æœï¼')}},
      {text:'ã€Œä»Šã¯ã¾ã æ—©ã„â€¦ã€',fn:()=>{addLog('ğŸ“º TVå–æã‚’æ–­ã£ãŸ');toast('ãƒãƒ£ãƒ³ã‚¹ã‚’é€ƒã—ãŸâ€¦')}}
    ]},
];

function checkEvents(){
  EVENTS.forEach(ev=>{
    if(!G.eventsDone.includes(ev.id)&&ev.cond()){
      G.eventsDone.push(ev.id);
      showEvent(ev);
    }
  });
}

// ---- ENDINGS ----
function checkEndings(){
  if(G.cash<=0){showEnding('ğŸ’€','å€’ç”£ã‚¨ãƒ³ãƒ‰','è³‡é‡‘ãŒã‚¼ãƒ­ã«â€¦ã€Œã™ã¾ã‚“ã€ã¿ã‚“ãªâ€¦ã€å±±ç”°ç¤¾é•·ã¯æ·±ãé ­ã‚’ä¸‹ã’ãŸã€‚ã—ã‹ã—ã€ã“ã®çµŒé¨“ã¯ç„¡é§„ã«ã¯ãªã‚‰ãªã„ã€‚');return}
  if(G.year>=3&&G.profitRate>20&&G.popularity>70){showEnding('ğŸ†','ç¹ç››åº—ã‚¨ãƒ³ãƒ‰','3å¹´ç›®ã«ã—ã¦ç¹ç››åº—ã«ï¼ã€Œæ•°å­—ã‚’è¦‹ã‚‹ã®ãŒæ€–ããªããªã£ãŸã€ã¨ç¤¾é•·ã¯ç¬‘ã£ãŸã€‚');return}
  if(G.year>=3&&G.presidentStage>=2&&G.profitRate>10){showEnding('ğŸŒŸ','æ”¹å¿ƒã‚¨ãƒ³ãƒ‰','ãƒ€ãƒ¡ç¤¾é•·ãŒå¤‰ã‚ã£ãŸã€‚æ•°å­—ã¨å‘ãåˆã„ã€ã‚¹ã‚¿ãƒƒãƒ•ã‚’ä¿¡ã˜ã€ãŠå®¢æ§˜ã«æ„›ã•ã‚Œã‚‹åº—ã«ã€‚');return}
  if(G.year>=5){showEnding('ğŸ“–','5å¹´ç›®ã‚¨ãƒ³ãƒ‰','5å¹´é–“ã®çµŒå–¶ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚å±±ç”°ç¤¾é•·ã®å±…é…’å±‹ã¯ä»Šæ—¥ã‚‚ç¯ã‚ŠãŒç‚¹ã„ã¦ã„ã‚‹ã€‚');}
}

// ---- AUTO PILOT ----
function toggleAuto(){
  G.autoMode=!G.autoMode;
  if(G.autoMode){
    startAuto();
    addLog('ğŸ¤– è‡ªå‹•é‹è»¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
  }else{
    stopAuto();
    addLog('ğŸ›‘ è‡ªå‹•é‹è»¢ãƒ¢ãƒ¼ãƒ‰çµ‚äº†');
  }
  updateAll();
}
function startAuto(){
  stopAuto();
  const speeds={slow:2500,normal:1200,fast:400};
  G.autoTimer=setInterval(()=>{
    if(!G.autoMode)return stopAuto();
    autoDecision();
    advanceWeek();
  },speeds[G.autoSpeed]||1200);
}
function stopAuto(){
  if(G.autoTimer){clearInterval(G.autoTimer);G.autoTimer=null}
}
function autoDecision(){
  const st=G.autoStrategy;
  // Price optimization
  if(st==='profit'||st==='balanced'){
    G.menu.forEach(m=>{
      const cr=costRate(m.cost,m.price);
      if(cr>35)m.price=Math.floor(m.price*1.05);
    });
  }
  // Staff care
  if(st==='popularity'||st==='balanced'){
    G.staff.forEach(s=>{
      if(s.fatigue>60){s.fatigue=Math.max(0,s.fatigue-15);s.morale=Math.min(100,s.morale+5)}
    });
  }
  // Advertising
  if(st==='growth'&&G.popularity<50&&G.cash>200000){
    G.cash-=30000;G.popularity=Math.min(100,G.popularity+3);G.snsFollower+=Math.floor(Math.random()*50);
  }
  // Loan if broke
  if(G.cash<200000&&G.loan===0){G.loan=500000;G.cash+=500000;addLog('ğŸ¦ è‡ªå‹•èè³‡ã‚’å®Ÿè¡Œ')}
}

// ---- UI HELPERS ----
function fmt(n){return Math.abs(n).toLocaleString('ja-JP')}
function $(id){return document.getElementById(id)}
function toast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  $('toastC').appendChild(t);setTimeout(()=>t.remove(),2500);
}
function addLog(msg){
  const w=`${G.year}å¹´${G.month}æœˆ${G.week}é€±`;
  G.logs.unshift({t:w,m:msg});
  if(G.logs.length>50)G.logs.pop();
}

// ---- EVENT MODAL ----
function showEvent(ev){
  if(G.autoMode&&Math.random()<0.6)return; // auto skips some events
  const overlay=document.createElement('div');overlay.className='modal-overlay';
  overlay.innerHTML=`<div class="modal-box">
    <h2>ğŸ“– ${ev.title}</h2>
    <p>${ev.desc}</p>
    <div>${ev.choices.map((c,i)=>`<button class="choice-btn" data-i="${i}">${c.text}</button>`).join('')}</div>
  </div>`;
  $('modalC').appendChild(overlay);
  overlay.querySelectorAll('.choice-btn').forEach(btn=>{
    btn.onclick=()=>{ev.choices[+btn.dataset.i].fn();overlay.remove();updateAll()};
  });
}

// ---- ENDING ----
function showEnding(icon,title,desc){
  stopAuto();G.autoMode=false;
  const ov=document.createElement('div');ov.className='ending-overlay';
  ov.innerHTML=`<div class="rank">${icon}</div><h1>${title}</h1><p>${desc}</p>
  <p style="margin-top:12px;font-size:.75rem;color:rgba(255,255,255,.5)">
  æœ€çµ‚æˆç¸¾ï¼šæœˆå•†Â¥${fmt(G.salesHistory.length?G.salesHistory[G.salesHistory.length-1]:0)} / äººæ°—åº¦${G.popularity} / ç¤¾é•·Lv.${G.presidentLevel}</p>
  <button class="btn-p" style="margin-top:16px;padding:12px 30px" onclick="this.parentElement.remove();resetGame()">ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>`;
  document.body.appendChild(ov);
}

// ---- RENDER ----
function updateAll(){
  // Header
  $('dateDisp').textContent=`${G.year}å¹´ç›® ${G.month}æœˆ ${G.week}é€±`;
  $('cashDisp').textContent=fmt(G.cash);
  if(G.cash<100000)$('cashDisp').style.color='#ef9a9a';
  else if(G.cash<300000)$('cashDisp').style.color='#ffe082';
  else $('cashDisp').style.color='';

  // Metrics
  $('metricsRow').innerHTML=[
    {l:'æœˆå•†',v:'Â¥'+fmt(G.monthlySales),c:G.monthlySales>0},
    {l:'åˆ©ç›Šç‡',v:G.profitRate+'%',c:G.profitRate>0},
    {l:'äººæ°—åº¦',v:G.popularity,c:G.popularity>50},
    {l:'ãƒªãƒ”ãƒ¼ãƒˆç‡',v:G.repeatRate+'%',c:G.repeatRate>30},
    {l:'å®¢å˜ä¾¡',v:'Â¥'+fmt(G.customerAvg),c:true},
  ].map(m=>`<div class="card"><div class="card-title">${m.l}</div><div class="card-val">${m.v}</div></div>`).join('');

  // President msg
  const msgs=G.presidentStage===0?
    ['ã€Œæ•°å­—ï¼Ÿãã‚“ãªã®è¦‹ãªãã¦ã‚‚ï¼ã€','ã€Œã¾ã‚ä½•ã¨ã‹ãªã‚‹ã•â€¦å¤šåˆ†ã€','ã€ŒãŠå®¢ã•ã‚“ãŒæ¥ã‚Œã°å„²ã‹ã‚‹â€¦ã‚ˆãªï¼Ÿã€']:
    G.presidentStage===1?
    ['ã€ŒåŸä¾¡ç‡ã£ã¦ã“ã†ã„ã†ã“ã¨ã‹â€¦ã€','ã€Œé›»å“ã£ã¦ä¾¿åˆ©ã ãªã€','ã€Œã‚‚ã£ã¨å‹‰å¼·ã—ãªã„ã¨ã€']:
    G.presidentStage>=2?
    ['ã€Œæ•°å­—ã®è£ã«äººãŒã„ã‚‹ã€','ã€Œã‚¹ã‚¿ãƒƒãƒ•ã‚ã£ã¦ã®åº—ã ã€','ã€ŒçµŒå–¶ã£ã¦é¢ç™½ã„ãªï¼ã€']:
    ['ã€Œä»Šæ—¥ã‚‚é ‘å¼µã‚‹ãï¼ã€'];
  $('presMsg').textContent=msgs[Math.floor(Math.random()*msgs.length)];

  // Auto btn
  $('btnAuto').textContent=G.autoMode?'ğŸ¤– è‡ªå‹•ON':'ğŸ¤– è‡ªå‹•OFF';
  $('btnAuto').className=G.autoMode?'btn-p':'btn-s';
  $('autoBadge').className='auto-badge'+(G.autoMode?' on':'');
  $('stratRow').style.display=G.autoMode?'flex':'none';
  $('speedRow').style.display=G.autoMode?'flex':'none';

  // Logs
  $('logBody').innerHTML=G.logs.slice(0,20).map(l=>`<div class="log-e"><span class="log-t">${l.t}</span><span>${l.m}</span></div>`).join('');

  // Menu tab
  $('avgCostR').textContent=avgCostRate()+'%';
  $('menuList').innerHTML=G.menu.map(m=>{
    const cr=costRate(m.cost,m.price);
    const cls=cr<=30?'cb-ok':cr<=40?'cb-warn':'cb-bad';
    return `<div class="menu-item">
      <div class="mi-left">
        <div class="mi-name">${m.emoji} ${m.name} ${'â­'.repeat(Math.floor(m.popularity/25))}</div>
        <div class="mi-meta">åŸä¾¡Â¥${m.cost} <span class="cost-badge ${cls}">åŸä¾¡ç‡${cr}%</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="mi-price">Â¥${fmt(m.price)}</div>
        <button class="btn-o btn-sm" onclick="editMenu(${m.id})">âœï¸</button>
      </div>
    </div>`;
  }).join('');

  // Staff tab
  $('avgMorale').textContent=avgMorale()+'%';
  $('staffList').innerHTML=G.staff.map(s=>`<div class="staff-card">
    <div class="s-avatar">${s.emoji}</div>
    <div class="s-info">
      <div class="s-name">${s.name}</div>
      <div class="s-role">${s.role} / ã‚¹ã‚­ãƒ«${s.skill} / æœˆçµ¦Â¥${fmt(s.salary)}</div>
      <div class="s-stats"><span>å£«æ°—</span></div>
      <div class="gauge"><div class="gauge-fill g-morale" style="width:${s.morale}%"></div></div>
      <div class="s-stats"><span>ç–²åŠ´</span></div>
      <div class="gauge"><div class="gauge-fill g-fatigue" style="width:${s.fatigue}%"></div></div>
    </div>
    <button class="btn-o btn-sm" onclick="restStaff(${s.id})">ğŸ˜´ä¼‘</button>
  </div>`).join('');

  // Marketing
  $('followers').textContent=fmt(G.snsFollower);
  const adOptions=[
    {id:'none',label:'åºƒå‘Šãªã—',price:0},
    {id:'sns',label:'SNSåºƒå‘Š',price:30000},
    {id:'local',label:'åœ°åŸŸæƒ…å ±èªŒ',price:100000},
    {id:'tv',label:'TVã‚¹ãƒãƒƒãƒˆ',price:300000},
  ];
  $('adOpts').innerHTML=adOptions.map(a=>`<div class="ad-opt${G.adLevel===a.id?' sel':''}" onclick="setAd('${a.id}',${a.price})">
    <span>${a.label}</span><span class="price">${a.price?'Â¥'+fmt(a.price):'ç„¡æ–™'}</span>
  </div>`).join('');

  // Analysis
  const fl=flRatio();const be=breakEven();
  const analysisData=[
    {l:'FLæ¯”ç‡',v:fl+'%',b:fl<=55?'badge-ok':fl<=65?'badge-warn':'badge-bad',bl:fl<=55?'è‰¯å¥½':fl<=65?'è¦æ³¨æ„':'å±é™º'},
    {l:'åŸä¾¡ç‡',v:avgCostRate()+'%',b:avgCostRate()<=30?'badge-ok':avgCostRate()<=38?'badge-warn':'badge-bad',bl:avgCostRate()<=30?'è‰¯å¥½':'è¦æ”¹å–„'},
    {l:'å®¢å˜ä¾¡',v:'Â¥'+fmt(G.customerAvg)},
    {l:'å›è»¢ç‡',v:G.turnoverRate.toFixed(1)+'å›'},
    {l:'åº§å¸­æ•°',v:G.seats+'å¸­'},
    {l:'æç›Šåˆ†å²ç‚¹',v:'Â¥'+fmt(be)+'/æœˆ'},
    {l:'å€Ÿå…¥æ®‹é«˜',v:'Â¥'+fmt(G.loan)},
    {l:'ç¤¾é•·ãƒ¬ãƒ™ãƒ«',v:'Lv.'+G.presidentLevel},
    {l:'ãƒ‡ãƒ¼ã‚¿æ´»ç”¨åº¦',v:G.dataUsage},
  ];
  $('analysisMetrics').innerHTML=analysisData.map(d=>`<div class="metric-row">
    <span class="mr-label">${d.l}</span>
    <span><span class="mr-val">${d.v}</span>${d.b?`<span class="badge ${d.b}">${d.bl}</span>`:''}</span>
  </div>`).join('');

  // Advice
  const advices=[];
  if(avgCostRate()>35)advices.push('åŸä¾¡ç‡ãŒé«˜ã‚ã§ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾¡æ ¼ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚');
  if(fl>65)advices.push('FLæ¯”ç‡ãŒé«˜ã„ã§ã™ã€‚äººä»¶è²»ã‹é£Ÿæè²»ã‚’æœ€é©åŒ–ã—ã¾ã—ã‚‡ã†ã€‚');
  if(G.avgMorale<40)advices.push('ã‚¹ã‚¿ãƒƒãƒ•ã®å£«æ°—ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚æ‡‡è¦ªä¼šã‚„ä¼‘æš‡ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
  if(G.popularity<30)advices.push('äººæ°—åº¦ãŒä½ã„ã§ã™ã€‚SNSæŠ•ç¨¿ã‚„åºƒå‘Šã§èªçŸ¥åº¦ã‚’ä¸Šã’ã¾ã—ã‚‡ã†ã€‚');
  if(G.cash<200000)advices.push('âš ï¸ è³‡é‡‘ãŒå±é™ºæ°´æº–ã§ã™ï¼æ”¯å‡ºã‚’æŠ‘ãˆã‚‹ã‹èè³‡ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚');
  if(!advices.length)advices.push('é †èª¿ãªçµŒå–¶ã§ã™ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚');
  $('adviceBox').textContent=advices.join(' ');

  drawCharts();
}

// ---- CHARTS ----
let salesChartInst=null,analysisChartInst=null;
function drawCharts(){
  const labels=G.salesHistory.map((_,i)=>(i+1)+'æœˆ');
  const data=G.salesHistory;
  // Sales chart
  const ctx1=$('salesChart');
  if(salesChartInst)salesChartInst.destroy();
  if(ctx1&&data.length>0){
    salesChartInst=new Chart(ctx1,{type:'line',data:{labels,datasets:[{
      label:'æœˆå•†',data,borderColor:'#ff9800',backgroundColor:'rgba(255,152,0,.15)',
      fill:true,tension:.3,borderWidth:2,pointRadius:3,pointBackgroundColor:'#ffab40'
    }]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},
    scales:{x:{ticks:{color:'rgba(255,255,255,.4)',font:{size:10}},grid:{display:false}},
    y:{ticks:{color:'rgba(255,255,255,.4)',font:{size:10},callback:v=>'Â¥'+Math.round(v/10000)+'ä¸‡'},grid:{color:'rgba(255,255,255,.06)'}}}}});
  }
  // Analysis chart
  const ctx2=$('analysisChart');
  if(analysisChartInst)analysisChartInst.destroy();
  if(ctx2&&data.length>0){
    analysisChartInst=new Chart(ctx2,{type:'bar',data:{labels,datasets:[{
      label:'æœˆå•†',data,backgroundColor:'rgba(255,152,0,.4)',borderColor:'#ff9800',borderWidth:1,borderRadius:4
    }]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},
    scales:{x:{ticks:{color:'rgba(255,255,255,.4)',font:{size:10}},grid:{display:false}},
    y:{ticks:{color:'rgba(255,255,255,.4)',font:{size:10},callback:v=>'Â¥'+Math.round(v/10000)+'ä¸‡'},grid:{color:'rgba(255,255,255,.06)'}}}}});
  }
}

// ---- ACTIONS ----
function editMenu(id){
  const m=G.menu.find(x=>x.id===id);if(!m)return;
  const ov=document.createElement('div');ov.className='modal-overlay';
  ov.innerHTML=`<div class="modal-box">
    <h2>${m.emoji} ${m.name}</h2>
    <p>åŸä¾¡: Â¥${m.cost} / ç¾åœ¨ä¾¡æ ¼: Â¥${m.price} / åŸä¾¡ç‡: ${costRate(m.cost,m.price)}%</p>
    <div style="margin:12px 0">
      <label style="font-size:.8rem;color:rgba(255,255,255,.6)">è²©å£²ä¾¡æ ¼</label>
      <input type="range" id="priceSlider" min="${m.cost+50}" max="${m.cost*5}" step="50" value="${m.price}" style="width:100%;accent-color:var(--secondary)">
      <div style="text-align:center;font-size:1.2rem;font-weight:700;color:var(--accent)" id="priceLabel">Â¥${m.price}</div>
      <div style="text-align:center;font-size:.75rem;color:rgba(255,255,255,.5)" id="crLabel">åŸä¾¡ç‡: ${costRate(m.cost,m.price)}%</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-p btn-sm" style="flex:1" id="priceOk">æ±ºå®š</button>
      <button class="btn-o btn-sm" style="flex:1" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>`;
  $('modalC').appendChild(ov);
  const slider=ov.querySelector('#priceSlider');
  slider.oninput=()=>{
    ov.querySelector('#priceLabel').textContent='Â¥'+fmt(+slider.value);
    ov.querySelector('#crLabel').textContent='åŸä¾¡ç‡: '+costRate(m.cost,+slider.value)+'%';
  };
  ov.querySelector('#priceOk').onclick=()=>{m.price=+slider.value;ov.remove();updateAll();toast(`${m.name}ã®ä¾¡æ ¼ã‚’Â¥${fmt(m.price)}ã«å¤‰æ›´`);addLog(`ğŸ’° ${m.name}ã‚’Â¥${fmt(m.price)}ã«å¤‰æ›´ (åŸä¾¡ç‡${costRate(m.cost,m.price)}%)`)};
}

function restStaff(id){
  const s=G.staff.find(x=>x.id===id);if(!s)return;
  s.fatigue=Math.max(0,s.fatigue-30);s.morale=Math.min(100,s.morale+10);
  toast(`${s.name}ã‚’ä¼‘ã¾ã›ãŸ`);addLog(`ğŸ˜´ ${s.name}ã«ä¼‘æš‡ã‚’ä¸ãˆãŸ`);updateAll();
}

function setAd(level,price){
  if(price>G.cash){toast('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');return}
  if(G.adLevel!=='none'&&level!=='none'){toast('æ—¢ã«åºƒå‘Šå®Ÿæ–½ä¸­ã§ã™');return}
  G.adLevel=level;
  if(price>0){
    G.cash-=price;
    const boost={sns:5,local:12,tv:25};
    G.popularity=Math.min(100,G.popularity+(boost[level]||0));
    G.snsFollower+=Math.floor(price/100*(1+Math.random()));
    addLog(`ğŸ“¢ ${level==='sns'?'SNSåºƒå‘Š':level==='local'?'åœ°åŸŸæƒ…å ±èªŒ':'TVã‚¹ãƒãƒƒãƒˆ'}ã‚’å‡ºç¨¿ (Â¥${fmt(price)})`);
    toast('åºƒå‘Šã‚’å‡ºç¨¿ã—ã¾ã—ãŸï¼');
  }
  updateAll();
}

// Dev new menu
$('btnDev').onclick=()=>{
  if(G.cash<50000){toast('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“(Â¥50,000å¿…è¦)');return}
  G.cash-=50000;
  const names=[
    {name:'æ˜å¤ªå­ã‚‚ã¤é‹',emoji:'ğŸ²',cost:300,price:980,pop:65},
    {name:'è‡ªå®¶è£½ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼',emoji:'ğŸ¥©',cost:200,price:680,pop:70},
    {name:'ã‚¢ãƒœã‚«ãƒ‰ã‚µãƒ©ãƒ€',emoji:'ğŸ¥‘',cost:150,price:580,pop:60},
    {name:'æµ·è€ãƒãƒ¨',emoji:'ğŸ¦',cost:250,price:780,pop:72},
    {name:'ã ã—å·»ãç‰å­',emoji:'ğŸ¥š',cost:60,price:380,pop:68},
    {name:'ç‰›ã™ã˜ç…®è¾¼ã¿',emoji:'ğŸ¥˜',cost:280,price:750,pop:75},
    {name:'ãŸã“ã‚ã•ã³',emoji:'ğŸ™',cost:90,price:380,pop:58},
    {name:'ç„¼ããŠã«ãã‚Š',emoji:'ğŸ™',cost:50,price:300,pop:62},
  ];
  const available=names.filter(n=>!G.menu.find(m=>m.name===n.name));
  if(!available.length){toast('é–‹ç™ºã§ãã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');return}
  const picked=available[Math.floor(Math.random()*available.length)];
  G.menu.push({id:G.nextMenuId++,...picked,popularity:picked.pop});
  addLog(`ğŸ”¬ æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ${picked.name}ã€ã‚’é–‹ç™ºï¼`);toast(`æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ${picked.emoji}${picked.name}`);updateAll();
};

// Staff actions
$('btnHire').onclick=()=>{
  if(G.cash<30000){toast('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');return}
  G.cash-=30000;
  const names=[
    {name:'ã‚±ãƒ³ã‚¸',emoji:'ğŸ‘¦',role:'æ–°äºº',skill:25,salary:95000},
    {name:'ã‚¢ãƒ¤ã‚«',emoji:'ğŸ‘§',role:'ãƒ›ãƒ¼ãƒ«',skill:40,salary:110000},
    {name:'ãƒªãƒ¥ã‚¦',emoji:'ğŸ§‘',role:'ã‚­ãƒƒãƒãƒ³è£œåŠ©',skill:35,salary:105000},
    {name:'ã‚µãƒã‚³',emoji:'ğŸ‘©',role:'çµŒç†å…¼ä»»',skill:50,salary:120000},
  ];
  const p=names[Math.floor(Math.random()*names.length)];
  G.staff.push({id:G.nextStaffId++,...p,morale:80,fatigue:0});
  addLog(`ğŸ‘¤ ${p.name}(${p.role})ã‚’æ¡ç”¨ï¼`);toast(`${p.emoji}${p.name}ãŒå…¥åº—ï¼`);updateAll();
};
$('btnParty').onclick=()=>{
  if(G.cash<20000){toast('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');return}
  G.cash-=20000;G.staff.forEach(s=>{s.morale=Math.min(100,s.morale+15);s.fatigue=Math.max(0,s.fatigue-10)});
  addLog('ğŸ‰ æ‡‡è¦ªä¼šã‚’é–‹å‚¬ï¼å£«æ°—UP');toast('ã¿ã‚“ãªæ¥½ã—ã‚“ã§ã‚‹ï¼');updateAll();
};
$('btnTrain').onclick=()=>{
  if(G.cash<15000){toast('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');return}
  G.cash-=15000;G.staff.forEach(s=>s.skill=Math.min(100,s.skill+5));G.dataUsage+=3;
  addLog('ğŸ“š ã‚¹ã‚¿ãƒƒãƒ•ç ”ä¿®ã‚’å®Ÿæ–½');toast('ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ï¼');updateAll();
};

// SNS Post
$('btnPost').onclick=()=>{
  const text=$('postText').value.trim();
  const boost=text.length>10?Math.floor(3+Math.random()*5):Math.floor(1+Math.random()*3);
  G.snsFollower+=boost*10;G.popularity=Math.min(100,G.popularity+boost);
  addLog(`ğŸ“± SNSæŠ•ç¨¿: +${boost*10}ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼`);toast('æŠ•ç¨¿ã—ã¾ã—ãŸï¼');$('postText').value='';updateAll();
};

// Footer buttons
$('fSave').onclick=()=>{try{localStorage.setItem('izakaya-save',JSON.stringify(G));toast('ğŸ’¾ ã‚»ãƒ¼ãƒ–å®Œäº†ï¼')}catch(e){toast('ä¿å­˜ã«å¤±æ•—â€¦')}};
$('fLoad').onclick=()=>{try{const d=localStorage.getItem('izakaya-save');if(d){Object.assign(G,JSON.parse(d));updateAll();toast('ğŸ“‚ ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼')}else toast('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“')}catch(e){toast('èª­è¾¼ã«å¤±æ•—â€¦')}};
$('fReset').onclick=()=>{
  const ov=document.createElement('div');ov.className='modal-overlay';
  ov.innerHTML=`<div class="modal-box"><h2>ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼Ÿ</h2><p>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ã€‚æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ</p>
  <div style="display:flex;gap:8px"><button class="btn-p btn-sm" style="flex:1" id="resetOk">ã¯ã„</button>
  <button class="btn-o btn-sm" style="flex:1" onclick="this.closest('.modal-overlay').remove()">ã„ã„ãˆ</button></div></div>`;
  $('modalC').appendChild(ov);
  ov.querySelector('#resetOk').onclick=()=>{ov.remove();resetGame()};
};
$('fCalc').onclick=()=>{
  const ov=document.createElement('div');ov.className='modal-overlay';
  ov.innerHTML=`<div class="modal-box"><h2>ğŸ§® åŸä¾¡ç‡è¨ˆç®—æ©Ÿ</h2>
  <div style="margin:10px 0"><label style="font-size:.8rem;color:rgba(255,255,255,.6)">åŸä¾¡(å††)</label>
  <input type="number" id="calcCost" value="300" style="width:100%;padding:8px;background:rgba(0,0,0,.3);border:1px solid rgba(255,152,0,.3);border-radius:8px;color:var(--light);font-size:1rem;margin-top:4px"></div>
  <div style="margin:10px 0"><label style="font-size:.8rem;color:rgba(255,255,255,.6)">å£²ä¾¡(å††)</label>
  <input type="number" id="calcPrice" value="1000" style="width:100%;padding:8px;background:rgba(0,0,0,.3);border:1px solid rgba(255,152,0,.3);border-radius:8px;color:var(--light);font-size:1rem;margin-top:4px"></div>
  <div style="text-align:center;margin:16px 0"><div style="font-size:.8rem;color:rgba(255,255,255,.5)">åŸä¾¡ç‡</div>
  <div id="calcResult" style="font-size:2rem;font-weight:900;color:var(--accent)">30%</div>
  <div id="calcAdvice" style="font-size:.75rem;color:var(--success);margin-top:4px">é©æ­£ç¯„å›²ã§ã™</div></div>
  <button class="btn-o btn-sm" style="width:100%" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button></div>`;
  $('modalC').appendChild(ov);
  const update=()=>{
    const c=+ov.querySelector('#calcCost').value||0;
    const p=+ov.querySelector('#calcPrice').value||1;
    const r=Math.round(c/p*100);
    ov.querySelector('#calcResult').textContent=r+'%';
    const adv=ov.querySelector('#calcAdvice');
    if(r<=30){adv.textContent='âœ… é©æ­£ç¯„å›²ã§ã™';adv.style.color='var(--success)'}
    else if(r<=40){adv.textContent='âš ï¸ ã‚„ã‚„é«˜ã‚ã€‚ä¾¡æ ¼èª¿æ•´ã‚’æ¤œè¨';adv.style.color='var(--warning)'}
    else{adv.textContent='ğŸš¨ å±é™ºï¼å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦';adv.style.color='var(--danger)'}
  };
  ov.querySelector('#calcCost').oninput=update;
  ov.querySelector('#calcPrice').oninput=update;
};
$('fInfo').onclick=()=>{
  const ov=document.createElement('div');ov.className='modal-overlay';
  ov.innerHTML=`<div class="modal-box"><h2>â“ éŠã³æ–¹</h2>
  <p>ã‚ãªãŸã¯ãƒ€ãƒ¡ç¤¾é•·ãƒ»å±±ç”°å¤ªéƒã€‚å±…é…’å±‹ã€Œå‘æ—¥è‘µã€ã‚’ç«‹ã¦ç›´ã›ï¼</p>
  <p><b>åŸºæœ¬æ“ä½œ:</b><br>
  ã€Œ1é€±é–“é€²ã‚ã‚‹ã€ã§æ™‚é–“ãŒé€²ã¿ã¾ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾¡æ ¼ã®èª¿æ•´ã€ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€é›†å®¢æˆ¦ç•¥ã‚’é§†ä½¿ã—ã¦é»’å­—çµŒå–¶ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚</p>
  <p><b>é‡è¦æŒ‡æ¨™:</b><br>
  ãƒ»åŸä¾¡ç‡: 30%ä»¥ä¸‹ãŒç†æƒ³<br>
  ãƒ»FLæ¯”ç‡: 60%ä»¥ä¸‹ãŒå¥å…¨<br>
  ãƒ»äººæ°—åº¦: é«˜ã„ã»ã©å®¢ãŒæ¥ã‚‹<br>
  ãƒ»å£«æ°—: ä½ã„ã¨ã‚µãƒ¼ãƒ“ã‚¹ä½ä¸‹</p>
  <p><b>è‡ªå‹•é‹è»¢:</b><br>
  ONã«ã™ã‚‹ã¨è‡ªå‹•ã§çµŒå–¶åˆ¤æ–­ã€‚æˆ¦ç•¥ã¨é€Ÿåº¦ã‚’é¸ã¹ã¾ã™ã€‚</p>
  <p><b>ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°:</b><br>
  çµŒå–¶çŠ¶æ³ã«å¿œã˜ã¦è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«åˆ†å²ï¼</p>
  <button class="btn-o btn-sm" style="width:100%;margin-top:8px" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button></div>`;
  $('modalC').appendChild(ov);
};

function resetGame(){
  stopAuto();
  Object.assign(G,{
    year:1,month:4,week:1,totalWeeks:0,cash:500000,loan:0,
    monthlySales:0,monthlyExpenses:0,monthlyProfit:0,profitRate:0,flRatio:65,
    popularity:30,repeatRate:20,customerAvg:2800,turnoverRate:1.2,seats:30,dailyCustomers:45,
    snsFollower:1234,snsEngagement:3.2,adLevel:'none',reputation:65,dataUsage:10,
    presidentLevel:1,presidentExp:0,awakened:false,presidentStage:0,
    avgMorale:62,salesHistory:[],autoMode:false,autoStrategy:'balanced',autoSpeed:'normal',
    eventsDone:[],logs:[],
    menu:[
      {id:1,name:'æè±†',emoji:'ğŸ«›',cost:80,price:300,popularity:70},
      {id:2,name:'åˆºèº«ç››ã‚Š',emoji:'ğŸŸ',cost:800,price:1800,popularity:85},
      {id:3,name:'å”æšã’',emoji:'ğŸ—',cost:120,price:450,popularity:75},
      {id:4,name:'ãƒãƒ†ãƒˆãƒ•ãƒ©ã‚¤',emoji:'ğŸŸ',cost:60,price:350,popularity:60},
      {id:5,name:'ç„¼ãé³¥',emoji:'ğŸ¢',cost:100,price:400,popularity:72},
      {id:6,name:'ç”Ÿãƒ“ãƒ¼ãƒ«',emoji:'ğŸº',cost:150,price:500,popularity:90},
      {id:7,name:'ãƒã‚¤ãƒœãƒ¼ãƒ«',emoji:'ğŸ¥ƒ',cost:80,price:450,popularity:80},
      {id:8,name:'å†·å¥´',emoji:'ğŸ§Š',cost:40,price:280,popularity:55},
    ],
    staff:[
      {id:1,name:'æºã•ã‚“',emoji:'ğŸ‘¨â€ğŸ³',role:'æ¿å‰',morale:60,skill:80,fatigue:20,salary:250000},
      {id:2,name:'ã¿ã‚†ã',emoji:'ğŸ‘©â€ğŸ³',role:'ãƒã‚¤ãƒˆãƒªãƒ¼ãƒ€ãƒ¼',morale:70,skill:65,fatigue:30,salary:130000},
      {id:3,name:'ã‚¿ã‚±ã‚·',emoji:'ğŸ§‘â€ğŸ³',role:'æ–°äºº',morale:90,skill:30,fatigue:10,salary:100000},
    ],
    nextStaffId:4,nextMenuId:9,
  });
  addLog('ğŸ® æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼');updateAll();toast('æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼');
}

// ---- TAB SWITCHING ----
document.querySelectorAll('.tab-b').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab-b').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('pane-'+btn.dataset.tab).classList.add('active');
  };
});

// ---- BUTTON BINDINGS ----
$('btnNext').onclick=()=>advanceWeek();
$('btnAuto').onclick=toggleAuto;
$('logClear').onclick=()=>{G.logs=[];updateAll()};

// Strategy & speed buttons
document.querySelectorAll('.strat-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.strat-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');G.autoStrategy=btn.dataset.st;
    if(G.autoMode){stopAuto();startAuto()}
  };
});
document.querySelectorAll('.speed-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');G.autoSpeed=btn.dataset.sp;
    if(G.autoMode){stopAuto();startAuto()}
  };
});

// ---- SPLASH & INIT ----
(function init(){
  const fill=$('loadFill');
  let p=0;
  const iv=setInterval(()=>{
    p+=Math.random()*25+10;if(p>100)p=100;
    fill.style.width=p+'%';
    if(p>=100){
      clearInterval(iv);
      setTimeout(()=>{
        $('splash').classList.add('hide');
        $('app').classList.add('show');
        // Try load save
        try{const d=localStorage.getItem('izakaya-save');if(d){Object.assign(G,JSON.parse(d));toast('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ')}}catch(e){}
        addLog('ğŸ¶ å±…é…’å±‹ãƒ‰ãƒªãƒ•ã‚¿ãƒ¼ã€é–‹åº—ï¼');
        updateAll();
      },400);
    }
  },200);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</body>
</html>
